<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<title>Picklock</title>
	<style>
        :root {
            --color-hud: #33f0ff;
            --color-success: #77ff46;
            --color-fail: #dd1e28;
            --filter-glow-hud: drop-shadow(0 0 2px #00aadd) drop-shadow(0 0 100px #000000);
            --filter-glow-success: drop-shadow(0 0 2px #55dd22) drop-shadow(0 0 100px #000000);
            --filter-glow-fail: drop-shadow(0 0 2px #990811) drop-shadow(0 0 100px #000000);

            --difficulty-open-height: 8em;
            --difficulty-closed-height: 4em;
        }

        * {
            color: var(--color-hud);
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Consolas, Courier, monospace;
            /* font-weight: bold; */
            white-space: pre;
        }

        body {
            background-color: #111118;
            min-height: 500px;
        }

        .flex-row {
            display: flex;
            flex-direction: row;
        }
        .flex-col {
            display: flex;
            flex-direction: column;
        }

        #background {
            /*background-image: url('/source/Codioful\ -\ Pretty\ Heroic.jpg'); /* free image by Codioful @ Unsplash https://unsplash.com/photos/blue-and-black-digital-wallpaper-bKESVqfxass */
            background-image: url('/source/DALLE\ -\ Blue\ Flow.webp'); /* generated by DALLE */
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            filter: blur(8px);
            -webkit-filter: blur(8px);
            opacity: 0.4;
            display: block;
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        #background:after {
            content: "";
            display: block;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #11111800 0%,#111118bb 70%,#111118ff 100%);
            /* border-radius: 50%; */
            position: absolute;
            top: 0; left: 0;
        }

        #log {
            background-color: #33333318;
            filter: drop-shadow(0 0 1px #0ff8);
            position: absolute;
            top: 1vmax;
            left: 1vmax;
            padding: 1rem;
            overflow: hidden;
        }

        .frame-top, .frame-bot {
            border: 1px solid var(--color-hud);
            filter: drop-shadow(0 0 4px #00ffff);
            display: inline-block;
            position: absolute;
            height: 1.25em;
            width: 100%;
            left: 0;
        }
        .frame-top {
            border-bottom: none;
            top: 0;
        }
        .frame-bot {
            border-top: none;
            bottom: 0;
        }
        .frame-left, .frame-right {
            border: 1px solid var(--color-hud);
            filter: drop-shadow(0 0 4px #00ffff);
            display: inline-block;
            position: absolute;
            height: 100%;
            width: 1.25em;
            top: 0;
        }
        .frame-left {
            border-right: none;
            left: 0;
        }
        .frame-right {
            border-left: none;
            right: 0;
        }

        .centered-label {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 1em;
            
            width: 100%;
        }

        #lock-box {
            border: 8px double var(--color-hud);
            border-radius: 50%;
            filter: var(--filter-glow-hud);
            display: inline-block;
            position: absolute;
            height: 32rem;
            width: 32rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
        }
        .lock-pip {
            border: 2px solid var(--color-hud);
            border-radius: 50%;
            display: inline-block;
            position: absolute;
            height: 1.25rem;
            width: 1.25rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
        }
        .final-pip {
            height: 2.5rem;
            width: 2.5rem;
        }

        #lock-icon-center {
            filter: var(--filter-glow-hud);
            display: inline-block;
            position: absolute;
            height: 14rem;
            width: 14rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
        }



        .controls-key, .controls-spacebar {
            border: 2px solid var(--color-hud);
            border-radius: 0.5em;
            display: inline-block;
            font-size: 1.5em;
            text-align: center;
            align-self: center;
        }
        .controls-key {
            width: 2.5em;
            height: 2.5em;
        }
        .controls-spacebar {
            width: 6em;
            height: 2.5em;
        }

        #difficulty-container {
            background-color: #33333318;
            filter: drop-shadow(0 0 1px #0ff8);
            position: absolute; /* positioning a flex-container prevents its default width:100% behavior */
            top: 1vmax;
            right: 1vmax;
            padding: 1em;
            overflow: hidden;
        }
        .difficulty-button {
            background-color: #33333318;
            border: 1px solid var(--color-hud);
            padding: 0.5em;
            margin: 0em 0.5em;
            text-align: center;
        }



        @keyframes difficulty-open-vertical {
              0% { height: var(--difficulty-closed-height); padding: 0em 1em; }
            100% { height: var(--difficulty-open-height);   padding: 1em 1em; }
        }
        @keyframes difficulty-close-vertical {
              0% { height: var(--difficulty-open-height);   padding: 1em 1em; }
            100% { height: var(--difficulty-closed-height); padding: 0em 1em; }
        }
    </style>
</head>
<body>

    <div id='background'></div>
    <div id='log'>
        <div class='frame-top'></div>
        <div class='frame-bot'></div>
    </div>
    <div id='lock-box'>
        <div class='lock-pip'></div>
    </div>
    <svg id='lock-icon-center' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <!-- magenta by default for error detection -->
        <path id='lock-icon' fill='#ff00ff' fill-opacity='1' d='M 20 40 L 20 80 L 80 80 L 80 40 L 38 40 L 38 30 C 38 24 43 19 50 19 C 57 19 62 24 62 30 L 62 40 L 72 40 L 72 30 C 72 18 62 10 50 10 C 38 10 28 18 28 30 L 28 40 Z'></path>
	</svg>
    <div id='difficulty-container' class='flex-col'>
        <div class='centered-label'>CHANGE DIFFICULTY</div>
        <div class='flex-row'>
            <div class='difficulty-button' onclick='setEasy()'>[1] Easy</div>
            <div class='difficulty-button' onclick='setMed()' >[2] Medium</div>
            <div class='difficulty-button' onclick='setHard()'>[3] Hard</div>
        </div>
        <div class='frame-left'></div>
        <div class='frame-right'></div>
    </div>

    <div class='flex-col' style='justify-items:center; gap:0.5em; padding:1em; position:absolute;'> <!-- element is only 50% as bright if not positioned, for some reason -->
        <div class='controls-key'>W</div>
        <div class='flex-row' style='justify-content:center; gap:0.5em;'>
            <div class='controls-key'>A</div>
            <div class='controls-key'>S</div>
            <div class='controls-key'>D</div>
        </div>
        <div class='controls-spacebar'>Space</div>
    </div>

    <script type='text/javascript'>

        //// DOM ////

        const msgLog = document.getElementById('log');
        const lockBox = document.getElementById('lock-box');
        const lockIcon = document.getElementById('lock-icon-center');

        const SVG_LOCKED = 'M 20 40 L 20 80 L 80 80 L 80 40 L 38 40 L 38 30 C 38 24 43 19 50 19 C 57 19 62 24 62 30 L 62 40 L 72 40 L 72 30 C 72 18 62 10 50 10 C 38 10 28 18 28 30 L 28 40 Z';
        const SVG_UNLOCKED = 'M 20 45 L 20 85 L 80 85 L 80 45 L 38 45 L 38 25 C 38 19 43 14 50 14 C 57 14 62 19 62 25 L 62 35 L 72 35 L 72 25 C 72 13 62 5 50 5 C 38 5 28 13 28 25 L 28 45 Z';

        const MSG_INSTRUCTIONS = [
            'CONTROLS',
            '',
            '[Easy] A,D           (or arrow keys)',
            '[ Med] W,A,S,D       (or arrow keys)',
            '[Hard] W,A,S,D,Space (or arrow keys)',
            '',
            '[r] to re-gen new lock with current settings'

        ].join('\n');
        msgLog.innerHTML = MSG_INSTRUCTIONS + `<div class = 'frame-top'></div><div class = 'frame-bot'></div>`;
        

        const CSSVars = {
            get : (k) => getComputedStyle(document.documentElement).getPropertyValue(k),
            set : (k,v) => document.documentElement.style.setProperty(k,v)
        };
        const randI = (min,max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randInt = (min,max) => {
            if (min > max) [min,max] = [max,min];
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function spawnPips (numPips) {
            const n = numPips ?? lock.combo.length;
            const dTheta = 2*Math.PI / n;

            let elemStr = '';
            for (let i = 0; i < n; i++) {
                const theta = i*dTheta - Math.PI/2 + dTheta;
                elemStr += `<div id="pip-${i}" class="lock-pip ${(i==n-1)?'final-pip':''}" style="transform:rotate(${theta}rad)translate(200px)rotate(${-theta}rad)translate(-50%,-50%)"></div>`;
            }
            lockBox.innerHTML = elemStr;
        }
        function updatePips () {
            const color = (lock.progress == lock.combo.length) ? 'var(--color-success)' : 'var(--color-hud)'; // will never be used for bg if lock just failed
            for (let i = 0; i < lock.combo.length; i++) {
                let elem = document.getElementById(`pip-${i}`);
                elem.style.backgroundColor = (i < lock.progress) ? color : 'transparent';
                elem.style.borderColor = (lock.failed) ? 'var(--color-fail)' : color;
            }
            lockBox.style.filter =
                (lock.progress == lock.combo.length) ? 'var(--filter-glow-success)' :
                (lock.failed) ? 'var(--filter-glow-fail)' :
                'var(--filter-glow-hud)';
        }
        function updateLockIcon () {
            const color = // svg can't use CSS vars, so extract the relevant colors
                (lock.progress == lock.combo.length) ? CSSVars.get('--color-success') :
                (lock.failed) ? CSSVars.get('--color-fail') :
                CSSVars.get('--color-hud');
            lockIcon.innerHTML = (lock.progress == lock.combo.length)
                ? (`<path id='lock-icon' fill='${color}' fill-opacity='1' d='${SVG_UNLOCKED}'></path>`)
                : (`<path id='lock-icon' fill='${color}' fill-opacity='1' d='${SVG_LOCKED}'></path>`);
            lockIcon.style.filter =
                (lock.progress == lock.combo.length) ? 'var(--filter-glow-success)' :
                (lock.failed) ? 'var(--filter-glow-fail)' :
                'var(--filter-glow-hud)';
        }
        function advance () {
            console.log(`${lock.progress} / ${lock.combo.length}`);
        }
        function succeed () {
            console.log(`Congrats, you picked the lock in ${lock.moves} moves!`);
        }
        function fail () {
            console.log(`Wrong move, lock reset...`);
        }


        let lock = {
            numDirs : undefined,
            moves : 0,
            progress : 0,
            combo : [],
            failed : false,
            reset : (length, dirs) => {
                const comboLength = Math.max(1, length ?? ((lock.combo.length>0) ? lock.combo.length : 8));
                const numDirs = Math.max(1, (dirs ?? lock.numDirs ?? 4));
                lock.numDirs = numDirs;
                lock.moves = 0;
                lock.progress = 0;
                lock.combo = [];
                lock.failed = false;
                for (let i = 0; i < comboLength; i++) {
                    lock.combo.push( randInt(0,numDirs-1) );
                }
                console.log(`Lock is reset. (${numDirs} dirs, ${comboLength} moves long)`);
            },
            try : (dir) => {
                lock.failed = false;
                if (lock.progress == lock.combo.length) {
                    console.log('The lock is already picked...');
                } else if (dir > lock.numDirs) {
                    console.log(`That direction isn't used on this difficulty...`);
                } else if (dir == lock.combo[lock.progress]) {
                    lock.moves++;
                    lock.progress++;
                    (lock.progress == lock.combo.length) ? succeed() : advance();
                } else {
                    lock.moves++;
                    lock.progress = 0;
                    lock.failed = true;
                    fail();
                }
            }
        }

        function regen   () { lock.reset();     spawnPips(); updateLockIcon(); }
        function setEasy () { lock.reset(8,2);  spawnPips(); updateLockIcon(); }
        function setMed  () { lock.reset(8,4);  spawnPips(); updateLockIcon(); }
        function setHard () { lock.reset(10,5); spawnPips(); updateLockIcon(); }

        let dbgToggle = true;
        window.addEventListener('keydown', e => {
            // console.log(e.key);
            switch (e.key) {
            // difficulty settings
            case '1': setEasy(); break;
            case '2': setMed();  break;
            case '3': setHard(); break;
            case 'r': regen();   break;
            // controls
            case 'a':
            case 'ArrowLeft':
                lock.try(0); updatePips(); updateLockIcon(); break;
            case 'd':
            case 'ArrowRight':
                lock.try(1); updatePips(); updateLockIcon(); break;
            case 'w':
            case 'ArrowUp':
                lock.try(2); updatePips(); updateLockIcon(); break;
            case 's':
            case 'ArrowDown':
                lock.try(3); updatePips(); updateLockIcon(); break;
            case ' ':
                lock.try(4); updatePips(); updateLockIcon(); break;
            // debug
            case '`':
                console.log('DEV KEY');
                const e = document.getElementById('difficulty-container');
                dbgToggle = !dbgToggle;
                e.style.animation = (dbgToggle) ? 'difficulty-open-vertical 0.25s' : 'difficulty-close-vertical 0.25s';
                e.style.height    = (dbgToggle) ? 'var(--difficulty-open-height)' : 'var(--difficulty-closed-height)';
                e.style.padding   = (dbgToggle) ? '1em 1em' : '0em 1em';
                
                break;
            }
        });

        // init
        console.log(MSG_INSTRUCTIONS);
        setEasy();
        // updateLockIcon();

    </script>

</body>